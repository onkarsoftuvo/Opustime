
<dialog-panel header="header">
    <dialog-header header="header">
        <button class="cancel_btn" ui-sref="invoice" ng-if="!$stateParams.patient_id && !$state.includes('appointment')">
            {{'button.cancel' | translate:translationData}}
        </button>
        <button class="cancel_btn" ui-sref="patient-detail({'patient_id' : $stateParams.patient_id})" ng-if="$stateParams.patient_id">
            {{'button.cancel' | translate:translationData}}
        </button>
        <button class="cancel_btn" ui-sref="appointment" ng-if="$state.includes('appointment')">
            {{'button.cancel' | translate:translationData}}
        </button>
         <button class="save_btn" type="submit" form="InvoiceForm" ng-if="!editInvoice">
            {{'button.save' | translate:translationData}}
        </button>
        <button class="save_btn" type="submit" form="InvoiceForm" ng-if="editInvoice && editInvoiceForm">
            {{'button.update' | translate:translationData}}
        </button>
        <button class="save_btn" type="button" ng-click="doEdit()" ng-if="!editInvoiceForm && invPerm.modify">
            {{'button.edit' | translate:translationData}}
        </button>
        <!--<button class="delete_btn" form="newContacts" ng-if="editInvoice && !$stateParams.patient_id && !$state.includes('appointment') && invPerm.delete" ng-click="DeleteInvoice('sm', InvoiceDetails.tax_invoice, $event)" >-->
            <!--{{'button.delete' | translate:translationData}}-->
        <!--</button>-->
        <button class="delete_btn" form="newContacts" ng-if="editInvoice && !$state.includes('appointment') && invPerm.delete" ng-click="DeleteInvoice('sm', InvoiceDetails.tax_invoice, $event)" >
            {{'button.delete' | translate:translationData}}
        </button>
        <button class="print_btn" form="newContacts" ng-if="editInvoice" ng-click="PrintInvoice(InvoiceDetails.id)">
            {{'button.print' | translate:translationData}}
        </button>
        <button class="email_btn" form="newContacts" ng-if="editInvoice && InvoiceDetails.email_to_patient != '' && InvoiceDetails.email_to_patient != null" ng-click="emailPatient(InvoiceDetails.id,InvoiceDetails.email_to_patient)">
            {{'button.emailToPatient' | translate:translationData}}
        </button>
        <button class="email_btn" type="submit" form="newContacts" ng-if="editInvoice && InvoiceDetails.email_to_other != '' && InvoiceDetails.email_to_other != null" ng-click="emailOther(InvoiceDetails.id,InvoiceDetails.email_to_other)">
            {{'button.emailToOther' | translate:translationData}}
        </button>
        <button class="payment_btn" ui-sref="invoice.newPayment({invoice_id:InvoiceDetails.tax_invoice})" ng-if="InvoiceDetails.outstanding_balance>0 && editInvoice && !$state.includes('appointment') && !$state.patient_id && invPerm.manage_payment">
            {{'button.enterPayment' | translate:translationData}}
        </button>
        <button class="payment_btn" ui-sref="appointment.newPayment({invoice_id:InvoiceDetails.tax_invoice})" ng-if="InvoiceDetails.outstanding_balance>0 && editInvoice && $state.includes('appointment') && !$state.patient_id && invPerm.manage_payment">
            {{'button.enterPayment' | translate:translationData}}
        </button>
        <button class="payment_btn" ui-sref="appointment.newPayment({invoice_id:InvoiceDetails.tax_invoice})" ng-if="InvoiceDetails.outstanding_balance>0 && editInvoice && $state.includes('appointment') && $state.patient_id && invPerm.manage_payment">
            {{'button.enterPayment' | translate:translationData}}
        </button>
    </dialog-header>
    <div class="navigate_arrow" ng-if="!$stateParams.patient_id && !$state.includes('appointment')">
        <div class="arrow_btn pre_btn">
            <a href="" ui-sref="invoice.edit({invoice_id : invoice.prev_invoice})" ng-if="invoice.prev_invoice != null"></a>
        </div>
        <div class="arrow_btn next_btn">
            <a href="" ui-sref="invoice.edit({invoice_id : invoice.next_invoice})" ng-if="invoice.next_invoice != null"></a>
        </div>
    </div>
    <div class="tab_contents">
      <div class="top_detail_con" ng-if="editInvoice && !editInvoiceForm">
        <div class="detail_con left_side_con">
            <h4>{{Contact.title}} {{Contact.first_name}} {{Contact.last_name}}</h4>
            <div class="detail_content">
                <div class="row">
                    <div class="col-sm-5 invoiceDate">
                        <h5><span>{{'patient.accountStatement.invoiceDate' | translate:translationData}}</span> : {{InvoiceDetails.issue_date}}</h5>
                        <h5><span>{{'payment.patient' | translate:translationData}}</span> :
                          <a ui-sref="patient-detail({patient_id:InvoiceDetails.patient_id})" class="text-capitalize">{{InvoiceDetails.patient}}</a>
                        </h5>
                        <h5 ng-if="InvoiceDetails.appt_date!=null">{{'invoice.appDate' | translate:translationData}} : {{InvoiceDetails.appt_date}}</h5>
                    </div>
                    <div class="col-sm-4 invoiceTax">
                        <h5><!-- {{'invoice.taxinvoice' | translate:translationData}} -->{{InvoiceDetails.invoice_title}} : #{{InvoiceDetails.id}}</h5>
                        <h5 class="text-capitalize">{{'invoice.practitioner' | translate:translationData}} : {{InvoiceDetails.practitioner}}<spann ng-if="InvoiceDetails.designation">({{InvoiceDetails.designation}})</spann></h5>
                        <h5 ng-repeat="con in InvoiceDetails.practitioner_contact">
                          <span ng-if="con.number != null">{{con.ref_type}} : {{con.number}}</span>
                        </h5>
                    </div>
                    <div class="col-sm-3 invoiceNote">
                        <div class="note_con">
                            {{!InvoiceDetails.notes? "Note" : InvoiceDetails.notes}}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="detail_content right_side_con">
          <div class="invoice_balance">
            <p ng-if="InvoiceDetails.patient_credit_balance" class="credit_blnc"><span>{{InvoiceDetails.patient | capitalize}}</span>  {{'invoice.hasAccount' | translate:translationData}} <span>${{InvoiceDetails.patient_credit_balance}}</span></p>
            <p ng-if="InvoiceDetails.patient_outstanding_balance" class="outstanding_amount"><span>{{InvoiceDetails.patient | capitalize}}</span> {{'invoice.hasOutstanding' | translate:translationData}} <span>${{InvoiceDetails.patient_outstanding_balance}}</span></p>
          </div>
        </div>
      </div>
      <div class="row" ng-if="!editInvoiceForm">
        <div class="col-md-12">
          <div class="row add_con">
            <div class="col-md-3 in_address">
              <label>{{'patient_detail.From' | translate:translationData}}</label>
              <div class="in_add_con">
                <p>{{InvoiceDetails.business.business_name}}</p>
                <p>
                  <span ng-if="InvoiceDetails.business.address">{{InvoiceDetails.business.address}}, </span>
                  <span ng-if="InvoiceDetails.business.state"> {{currentCon.$$state.value.state}}, </span>
                  <span ng-if="InvoiceDetails.business.pin_code">{{InvoiceDetails.business.pin_code}}</span>
                </p>
                <p>
                  <span ng-if="InvoiceDetails.business.country">{{currentCon.$$state.value.country}}</span>
                </p>
                <p ng-if="InvoiceDetails.business.show_contact_info">{{InvoiceDetails.business.contact_info}}</p>
              </div>
            </div>
            <div class="col-md-4 in_address col-md-offset-1">
              <label>{{'invoice.billedTo' | translate:translationData}}</label>
              <div ng-if="InvoiceDetails.invoice_to" class="in_add_con">
                <p>{{InvoiceDetails.invoice_to}}</p>
              </div>
              <div ng-if="!InvoiceDetails.invoice_to" class="in_add_con">
                <p>{{InvoiceDetails.patient}}</p>
                <p>
                  <span ng-if="InvoiceDetails.patient_address.address">{{InvoiceDetails.patient_address.address}}, </span>
                  <span ng-if="InvoiceDetails.patient_address.city">{{InvoiceDetails.patient_address.city}}, </span>
                  <span ng-if="InvoiceDetails.patient_address.state">{{InvoiceDetails.patient_address.state}},</span>
                  <span ng-if="InvoiceDetails.patient_address.postal_code">{{InvoiceDetails.patient_address.postal_code}}</span>
                </p>
                <p ng-if="InvoiceDetails.patient_address.country">{{InvoiceDetails.patient_address.country}}</p>
              </div>
            </div>
            <div class="col-md-3 in_address col-xs-offset-1" ng-if="InvoiceDetails.next_appointment_status == true">
              <label>{{'appointment.nextApp' | translate:translationData}}</label>
              <div class="in_add_con">
                <p ng-if="InvoiceDetails.next_appointment_name!=null">{{InvoiceDetails.next_appointment_name}}</p>
                <p ng-if="InvoiceDetails.next_appointment_name==null">N/A</p>
              </div>
            </div>
          </div>
        </div>
        <div class="table-responsive table_view invoice-margin">
          <table class="table table-hover table-responsive">
            <thead>
              <tr>
                <th>{{'invoice.code' | translate}} </th>
                <th>{{'invoice.item' | translate}} </th>
                <th>{{'invoice.type' | translate}} </th>
                <th class="table-thPrice">{{'invoice.unitPrice' | translate}}</th>
                <th>{{'invoice.quantity' | translate}}</th>
                <th class="table-thTax">{{'invoice.tax' | translate}}</th>
                <th>{{'invoice.discount' | translate}}</th>
                <th>{{'invoice.totalPrice' | translate}}</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="invoices in InvoiceDetails.invoice_items">
                <td class="col-sm-1"><span>{{invoices.item_code}}</span></td>
                <td class="col-sm-3" ng-if="invoices.item_type=='BillableItem'"><span>{{invoices.name}}</span> <span style="color:green;" ng-if="invoices.invoice_items.concession_type!= null">{{invoices.invoice_items.concession_type}}</span></td>
                <td class="col-sm-3" ng-if="invoices.item_type=='Product'"><span>{{invoices.name}}</span></td>
                <td class="col-sm-1"><span class="">{{invoices.type}}</span></td>
                <td class="col-sm-1"><span>$ {{invoices.unit_price}}</span></td>
                <td class="col-sm-1"><span>{{invoices.quantity}}</span></td>
                <td class="col-sm-1"><span>{{invoices.tax}}</span></td>
                <td class="col-sm-2"><span ng-if="invoices.discount_type_percentage=='%' && invoices.discount!=null" >{{invoices.discount}}%</span> <span ng-if="invoices.discount_type_percentage=='$' && invoices.discount!=null" >${{invoices.discount}}</span></td>
                <td class="col-sm-2"><div class=" total-price"> <span class="pull-left">${{invoices.total_price}}</span> </div></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="total-list-full-details">
          <ul class="list-inline detail-list">
            <li>
              <h5>
              <span class="">{{'invoice.Total_Discount' | translate}}</span><span  class="pull-right" >$ {{InvoiceDetails.total_discount}}</span></li>
            <li>
              <h5><span  class="">{{'invoice.Tax' | translate}}</span><span  class="pull-right">{{InvoiceDetails.tax}}</span></h5>
            </li>
            <li>
              <h5><span  class="">{{'invoice.Invoice_Total' | translate}}</span><span  class="pull-right">$ {{InvoiceDetails.invoice_amount}}</span></h5>
            </li>
            <li>
              <h5><span class="">{{'invoice.Outstanding_Balance' | translate}}</span><span class="pull-right">$ {{InvoiceDetails.outstanding_balance | number : 2}}</span></h5>
            </li>
          </ul>
        </div>
        <div class="col-sm-12" ng-if="InvoiceDetails.payment_method !=''">
          <hr>
        </div>
        <div class="total-invoice" ng-if="InvoiceDetails.payment_method !=''" style="padding:0 15px;">
          <p>{{'invoice.paymentMethod' | translate}}</p>
          <div ng-repeat="payment_method in InvoiceDetails.payment_method">
            <p class="date"><a href="" ng-click="openPaymentView(payment_method.payment_id)">#{{payment_method.payment_id}}</a>{{payment_method.payment_date | date : 'mediumDate'}}</p>
            <p ng-repeat="payment_mode in payment_method.payment_datail.payment_modes" class="loop-total">{{payment_mode.name}} ${{payment_mode.amount}}</p>
            <p class="total-invoice-con">Total $ {{payment_method.payment_datail.alloted_amount}} allocated</p>
          </div>
        </div>
      </div>

      <form ng-submit="InvoiceForm.$valid && checkCreditBalance(invoice)"  id="InvoiceForm" class="products contact"  name="InvoiceForm" novalidate ng-show="editInvoiceForm">
          <div class="row trim_row">
            <div class="col-sm-12">
              <h4>{{'invoice.Invoice_Detail' | translate:translationData}}</h4>
            </div>
              <div class="col-sm-3">
                  <div class="form-group auto-complete-typehead">
                      <label>{{'payment.patient' | translate:translationData}}</label>
                      <input type="text" class="form-control search_box focus_me" placeholder="{{'appointment.searchPatient' | translate:translationData}}" typeahead="patients as patients.first_name+'&nbsp;'+patients.last_name for patients in PatientListData | filter:$viewValue | limitTo:30" typeahead-input-formatter="formatLabel($model)" ng-model="invoice.patient" typeahead-on-select="GetPatientDetails($item)" autofocus required="required">

                  </div>
              </div>
              <div class="col-sm-3">
                  <div class="form-group">
                      <label>{{'invoice.practitioner' | translate:translationData}}</label>
                      <select class="form-control" tabindex="0" ng-model="invoice.practitioner"
                       ng-change=" GetPractionerDetails(invoice.practitioner, invoice.business)"  ng-options="p.id as p.first_name + ' ' + p.last_name for p in practitioners">
                      </select>
                  </div>
              </div>
              <div class="col-sm-3">
                  <div class="form-group">
                      <label>{{'payment.issueDate' | translate:translationData}}</label>
                      <p class="input-group">
                      <input type="text" ng-model="invoice.issue_date" class="form-control" uib-datepicker-popup="{{format}}" is-open="status.opened" min-date="minDate" max-date="maxDate" datepicker-options="dateOptions" placeholder="YYYY-MM-DD"  ng-required="true" close-text="Close"   />
                      <span class="input-group-btn">
                      <button type="button" class="btn btn-default" ng-click="open($event)"><i class="glyphicon glyphicon-calendar"></i></button>
                      </span> </p>
                  </div>
              </div>
              <div class="col-sm-3">
                  <div class="form-group">
                      <label>{{'invoice.business' | translate:translationData}}</label>
                      <select class="form-control" ng-model="invoice.business" ng-options="b.id as b.name for b in BussinessList" ng-change="GetPractionerDetails(invoice.practitioner, invoice.business)" required>
                      </select>
                  </div>
              </div>
              <div class="col-sm-6">
                <div class="form-group">
                  <label>{{'invoice.appointment' | translate:translationData}}</label>
                  <select ng-show="patient.appointment.length" class="form-control" tabindex="0" ng-model="invoice.appointment" ng-change="getAppointmentTypeDetails(invoice.appointment)">
                     <option value="">{{'invoice.none' | translate:translationData}}</option>
                     <option ng-repeat="appontmenttypes in patient.appointment" value="{{appontmenttypes.appointment_id}}">{{appontmenttypes.appointment_name}}</option>
                  </select>
                  <select ng-show="!patient.appointment.length" class="form-control" tabindex="0" ng-model="invoice.appointment" ng-change="getAppointmentDetails(invoice.appointment)">
                    <option value="">{{'invoice.none' | translate:translationData}}</option>
                    <option ng-repeat="appontmenttypes in patient.appointment_type" value="{{appontmenttypes.id}}">{{appontmenttypes.name}}</option>
                  </select>
                </div>
              </div>
              <div class="col-sm-6">
                <div class="form-group">
                  <label>{{'invoice.invoiceTo' | translate:translationData}}</label>
                  <input type="text" class="form-control"  ng-model="invoice.invoice_to">
                </div>
              </div>
              <div class="col-sm-12">
                  <table class="total-list invoice_table">
                    <thead>
                      <tr>
                        <th>{{'invoice.item' | translate:translationData}} </th>
                        <th>{{'invoice.unitPrice' | translate:translationData}}</th>
                        <th>{{'invoice.quantity' | translate:translationData}}</th>
                        <th>{{'invoice.tax' | translate:translationData}}</th>
                        <th>{{'invoice.discount' | translate:translationData}}</th>
                        <th>{{'invoice.totalPrice' | translate:translationData}}</th>
                        <th>&nbsp;</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr ng-repeat="invoices in invoice.invoice_items_attributes">
                        <td class="col-sm-3" ng-if="invoices.item_type=='BillableItem'">
                            <select class="form-control" id="Billable{{$index}}" ng-model="invoices.item_id" ng-change="BillableItemDetails(invoices)"  ng-options="p.item_id as p.name for p in BilableItemsList">
                              <option value="">{{'invoice.selectBillable' | translate:translationData}}</option>
                            </select>
                            <input type="hidden" ng-model="invoices.concession_id">
                            <span style=" position: absolute; color:green;" ng-if="invoices.concession" class="con_Name">Discount Type: {{invoices.concession_name}}</span>
                        </td>
                        <td class="col-sm-2" ng-if="invoices.item_type=='Product'">
                            <select class="form-control" ng-change="ProductDetails(invoices)" ng-model="invoices.item_id"
                                  ng-options="s.item_id as s.name for s in ProductsList">
                              <option value="">{{'invoice.selectProduct' | translate:translationData}}</option>
                            </select>
                        </td>
                        <td class="col-sm-2">
                            <div class="currency"> <span class="dollor_sign">$</span> <span class="pull-right">
                              <input type="text" ng-blur="Calculation()" class="form-control"  ng-model="invoices.unit_price" ng-disabled="!invoices.item_id">
                              </span> </div>
                        </td>
                        <td class="col-sm-1">
                            <input type="text" ng-blur="Calculation()"  class="form-control"  ng-model="invoices.quantity" ng-disabled="!invoices.item_id">
                        </td>
                        <td class="col-sm-1">
                            <p >{{invoices.tax}}</p>
                            <input type="hidden" ng-model="invoices.tax_amount">
                        </td>
                        <td class="col-sm-2" >
                          <div class="discount-box">
                            <input type="text" ng-blur="Calculation()" class="form-control pull-left"  ng-model="invoices.discount" ng-disabled="!invoices.item_id">
                            <select class="form-control pull-right" ng-model="invoices.discount_type_percentage" ng-init="invoices.discount_type_percentage='%'" ng-change="Calculation()" ng-disabled="!invoices.item_id">
                              <option value="%">%</option>
                              <option value="$">$</option>
                            </select>
                          </div>
                        </td>
                        <td class="col-sm-2">
                          <div class=" total-price">
                              <span class="pull-left">{{invoices.total_price}}</span>
                          </div>
                        </td>
                        <td classs="">
                          <div ng-click="RemoveBillableProduct($index)" class="form-group total-price cross-it">
                              <a  href=""><i class="ic cross"></i> {{'expense.remove' | translate:translationData}}</a>
                          </div>
                        </td>
                      </tr>
                      <tr class="remove-bg">
                        <td colspan="3"><button type="Button" class="btn btn-black" ng-click="addBillableProduct()"><i class="fa fa-plus-circle"></i>{{'invoice.addBillableItem' | translate:translationData}}</button>
                          <button type="Button" ng-click="addProduct()" class="btn btn-black addProd-btn"><i class="fa fa-plus-circle"></i> {{'product.label_add_product' | translate:translationData}}</button></td>
                        <td></td>
                        <td></td>
                        <td class="invoice-full-details" colspan="2">
                          <ul class="list-inline">
                              <li><span class="pull-left" ng-modal="invoice.total_discount">{{'invoice.totalDiscount' | translate:translationData}}</span><span class="pull-right"><small ng-if="invoice.total_discount!=0">-</small>{{invoice.total_discount}} </span></li>
                              <li><span ng-modal="invoice.subtotal" class="pull-left">{{'invoice.subTotal' | translate:translationData}}</span><span class="pull-right">{{invoice.subtotal}}</span></li>
                              <li><span ng-modal="invoice.tax" class="pull-left">{{'product.label_tax' | translate:translationData}}</span><span  class="pull-right">{{invoice.tax}}</span></li>
                              <li><span ng-modal="invoice.invoice_amount" class="pull-left">{{'payment.invoiceTotal' | translate:translationData}}</span><span  class="pull-right">{{invoice.invoice_amount | number: 2}}</span></li>
                          </ul>
                        </td>
                      </tr>
                    </tbody>
                  </table>
              </div>
              <div class="col-sm-6">
                  <div class="form-group mess">
                    <label>{{'invoice.extraInfo' | translate:translationData}} </label>
                    <textarea placeholder="{{'invoice.eg_Claim_Number' | translate:translationData}}" ng-model="invoice.extra_patient_info"  class="form-control" ></textarea>
                  </div>
              </div>
              <div class="col-sm-6">
                  <div class="form-group mess">
                    <label>{{'product.label_note' | translate:translationData}}</label>
                    <textarea class="form-control" ng-model="invoice.notes"> </textarea>
                  </div>
              </div>
          </div>
      </form>
    </div>
</dialog-panel>
<!-- Modal -->
<script type="text/ng-template" id="DeleteModal.html">
  <div class="modal-body confirm-body">
    <div class="confirm">
      <p>{{'invoice.confirmDelete' | translate:translationData}}</p>
      <a href="" ng-click="okdelete()">{{'button.confirm' | translate:translationData}}</a>
      <a href="" ng-click="cancel()">{{'button.cancel' | translate:translationData}}</a>
    </div>
  </div>
</script>

<script type="text/ng-template" id="creditBalance.html">
    <div class="modal-body confirm-body">
        <div class="confirm">
            <p>{{'invoice.creditBalanceMsg_1' | translate:translationData}} {{credit_balance}} $.{{'invoice.creditBalanceMsg_2' | translate:translationData}}</p>
            <a href="" ng-click="createInvoiceCreditBal()">{{'patient_detail.yes' | translate:translationData}}</a>
            <a href="" ng-click="createInvoiceCreditBalCancel()">{{'patient_detail.no' | translate:translationData}}</a>
        </div>
    </div>
</script>

<style>